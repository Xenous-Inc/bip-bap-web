import React, { useEffect } from 'react';
import type { NextPage } from 'next';
import Head from 'next/head';
import pageStyles from '@styles/Page.module.css';
import styles from './Map.module.css';
import Header from '@components/organisms/Header';
import MapController from '@components/organisms/MapController';
import 'mapbox-gl/dist/mapbox-gl.css';
import { useSensors } from '../../hooks/Map.hooks';
import { Spinner } from '@chakra-ui/react';
import MapComponent from '@components/organisms/Map';
import { MapProvider, useMapContext } from '@context/MapContext';
import theme from '@styles/theme';

const Map: NextPage = () => {
    const { map, canvas, zoom } = useMapContext();
    const { isLoading, sensors, getSensors } = useSensors();

    useEffect(getSensors, []);

    useEffect(
        () =>
            sensors?.forEach(sensor => {
                const ctx = canvas?.getContext('2d');
                if (sensor.location && ctx && map) {
                    const pixels = map.project([sensor.location.coordinates[0], sensor.location.coordinates[1]]);

                    ctx.fillStyle = theme.colors.green;
                    ctx.beginPath();
                    ctx.arc(pixels.x, pixels.y, 20, 0, Math.PI * 2, false);
                    ctx.fill();
                }
            }),
        [sensors, map, canvas],
    );

    return (
        <div className={pageStyles.container}>
            <Head>
                <title>Карта</title>
                <meta name='description' content='Generated by create next app' />
                <link rel='icon' href='/favicon.ico' />
            </Head>

            <Header />

            <main className={styles.container__main}>
                <MapComponent className={styles.main__map} onMove={getSensors}>
                    {isLoading && (
                        <div className={styles.map__overlay}>
                            <Spinner color={'green'} size={'xl'} />
                        </div>
                    )}
                    <MapController
                        className={styles.map__controller}
                        onZoomIn={() => map?.flyTo({ zoom: zoom + 1 })}
                        onZoomOut={() => map?.flyTo({ zoom: zoom - 1 })}
                    />
                </MapComponent>
            </main>
        </div>
    );
};

export default () => (
    <MapProvider>
        <Map />
    </MapProvider>
);
